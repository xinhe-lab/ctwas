<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>cTWAS utility functions • ctwas</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="cTWAS utility functions">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ctwas</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.3.16</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Tutorial

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/minimal_tutorial.html">A minimal tutorial of running cTWAS without LD</a>
    </li>
    <li>
      <a href="../articles/preparing_input_data.html">Preparing cTWAS input data</a>
    </li>
    <li>
      <a href="../articles/running_ctwas_analysis.html">Running cTWAS analysis</a>
    </li>
    <li>
      <a href="../articles/summarizing_results.html">Summarizing and visualizing cTWAS results</a>
    </li>
    <li>
      <a href="../articles/postprocessing.html">Post-processing cTWAS results</a>
    </li>
    <li>
      <a href="../articles/utility_functions.html">cTWAS utility functions</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/xinhe-lab/ctwas/tree/singlegroup" class="external-link">Source</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><script src="utility_functions_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>cTWAS utility functions</h1>
                        <h4 data-toc-skip class="author">Kaixuan Luo, Sheng Qian</h4>
            
            <h4 data-toc-skip class="date">2024-07-25</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/xinhe-lab/ctwas/blob/singlegroup/vignettes/utility_functions.Rmd" class="external-link"><code>vignettes/utility_functions.Rmd</code></a></small>
      <div class="hidden name"><code>utility_functions.Rmd</code></div>

    </div>

    
    
<div class="section level4">
<h4 id="creating-ld-matrices-from-individual-level-genotype-data">Creating LD matrices from individual level genotype data<a class="anchor" aria-label="anchor" href="#creating-ld-matrices-from-individual-level-genotype-data"></a>
</h4>
<p>cTWAS provides a function, <code><a href="../reference/convert_geno_to_LD_matrix.html">convert_geno_to_LD_matrix()</a></code> to create LD matrices from individual level genotype data.</p>
<p>This function needs genotype files (<code>genotype_files</code>) and variant information files (<code>varinfo_files</code>) in PLINK format, and region definitions (<code>region_info</code>) as input, and it converts genotype data to LD matrices region-by-region, and save the LD correlation matrices (<code>.RDS</code> files) and corresponding variant information (<code>.Rvar</code> files) to the directory <code>outputdir</code>. It returns a data frame <code>region_metatable</code>, which contains region definitions from <code>region_info</code> and two additional columns “LD_file” and “SNP_file”. “LD_file” stores the filenames to the LD matrices (<code>.RDS</code> files), “SNP_file” stores the filenames of corresponding variant information (<code>.Rvar</code> files).</p>
<p>Below is an example for creating LD matrices using 1000 Genomes European genotype data.</p>
<p>You can download the 1000 Genomes European genotype data from <a href="https://uchicago.box.com/s/qqfq7wsl1fcbfjrcpwvyyspvfud3h2xa" class="external-link">here</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ldref_dir</span> <span class="op">&lt;-</span> <span class="st">"./1000G_EUR_Phase3_plink"</span></span>
<span><span class="va">genotype_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"1000G.EUR.QC."</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">22</span>, <span class="st">".bed"</span><span class="op">)</span></span>
<span><span class="va">varinfo_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"1000G.EUR.QC."</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">22</span>, <span class="st">".bim"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">region_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/ldetect"</span>, <span class="st">"EUR.b37.ldetect.regions.RDS"</span>, package <span class="op">=</span> <span class="st">"ctwas"</span><span class="op">)</span></span>
<span><span class="va">region_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">region_file</span><span class="op">)</span></span>
<span></span>
<span><span class="va">outputdir</span> <span class="op">&lt;-</span> <span class="st">"./cTWAS_LD"</span></span>
<span><span class="va">outname</span> <span class="op">&lt;-</span> <span class="st">"1000G_EUR_Phase3_b37"</span></span>
<span></span>
<span><span class="va">region_metatable</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_geno_to_LD_matrix.html">convert_geno_to_LD_matrix</a></span><span class="op">(</span><span class="va">region_info</span>,</span>
<span>                                              <span class="va">genotype_files</span>,</span>
<span>                                              <span class="va">varinfo_files</span>,</span>
<span>                                              chrom <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">22</span>,</span>
<span>                                              outputdir <span class="op">=</span> <span class="va">outputdir</span>,</span>
<span>                                              outname <span class="op">=</span> <span class="va">outname</span><span class="op">)</span></span></code></pre></div>
<p>You can download the precomputed LD files using the 1000 Genomes European genotype data from <a href="https://uchicago.box.com/s/bi7yy7461hdd07xafyk0qlji1kwmleu7" class="external-link">here</a></p>
<p>We provide example R scripts to create LD files for UK biobank or 1000 genomes genotype files <a href="https://github.com/xinhe-lab/ctwas/tree/singlegroup/inst/extdata/scripts" class="external-link">here</a></p>
</div>
<div class="section level3">
<h3 id="using-fusion-weights">Using FUSION weights<a class="anchor" aria-label="anchor" href="#using-fusion-weights"></a>
</h3>
<p>PredictDB is the recommended format for cTWAS, and we introduced how to use PredictDB weights in the tutorial “Preparing cTWAS input data”. Here, we will discuss how to use FUSION weights.</p>
<p>Please check <a href="http://gusevlab.org/projects/fusion/#compute-your-own-predictive-models" class="external-link">FUSION/TWAS</a> for the format of FUSION weights. You can download <a href="http://gusevlab.org/projects/fusion/#download-pre-computed-predictive-models" class="external-link">precomputed FUSION models</a></p>
<p>For example, we download an example GTEx whole blood data.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">wget</span> https://data.broadinstitute.org/alkesgroup/FUSION/WGT/GTEx.Whole_Blood.tar.bz2</span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="fu">tar</span> xjf GTEx.Whole_Blood.tar.bz2</span></code></pre></div>
<p>After unpacking the package, we will see a folder named <code>GTEx.Whole_Blood</code>, which contains the <code>.wgt.RDat</code> files of the precomputed weights. We will also see a file <code>GTEx.Whole_Blood.pos</code> (outside the weight folder), which points to the individual <code>.wgt.RDat</code> weight files, their gene IDs, and genomic positions.</p>
<p>We use the <code>preprocess_weight()</code> function to harmonize the prediction models and LD reference. To use the FUSION format, we need to specify the weight directory that contains the <code>.wgt.RDat</code> files. We specify <code>weight_format = 'FUSION'</code> and specify the prediction models in FUSION by <code>fusion_method</code>. It supports the following models: “lasso” (default), “enet”, “top1”, “blup”, “bslmm”, and also “best.cv”, which will choose the best model for each gene based on the cross-validation performance.</p>
<p>This function also takes a few other inputs, including the definition of regions (<code>region_info</code>), the list of variants from GWAS (<code>z_snp$id</code>), and the SNP to region map (<code>snp_map</code>). Please refer to the tutorial `Preparing input data” about these data structures.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/preprocess_weights.html">preprocess_weights</a></span><span class="op">(</span><span class="st">"./GTEx.Whole_Blood"</span>,</span>
<span>                              <span class="va">region_info</span>,</span>
<span>                              <span class="va">z_snp</span><span class="op">$</span><span class="va">id</span>,</span>
<span>                              <span class="va">snp_map</span>,                                  </span>
<span>                              weight_format <span class="op">=</span> <span class="st">"FUSION"</span>,</span>
<span>                              fusion_method <span class="op">=</span> <span class="st">"lasso"</span>,</span>
<span>                              drop_strand_ambig <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                              ncore <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span></code></pre></div>
<p>We drop strand ambiguous variants (<code>drop_strand_ambig = TRUE</code>) by default. FUSION weights are already on the standardized scale, so we don’t scale weights by the variance. For FUSION models, we don’t have precomputed covariances between variants. So we calculate correlations between weight variants using the LD reference. This usually takes a while, so it is helpful to set <code>ncore</code> to parallelize the computation. FUSION weights do not contain gene type information, so we don’t limit to protein coding genes.</p>
</div>
<div class="section level3">
<h3 id="creating-prediction-models-from-qtl-lists">Creating prediction models from QTL lists<a class="anchor" aria-label="anchor" href="#creating-prediction-models-from-qtl-lists"></a>
</h3>
<p>Often a researcher may have a list of significant eQTLs, but have not explicitly built prediction models. In such cases, it is possible to run cTWAS. One just needs to use the top eQTL per gene as the prediction models. Running cTWAS in this way would be similar to colocalization analysis with coloc. Nevertheless, it still has some advantages over coloc: it estimates the important parameters from data, and it analyzes multiple genes in a region simultaneously. See the Supplementary Note of the cTWAS paper for details.</p>
<p>We could convert top QTLs into PredictDB format weights using the function <code><a href="../reference/create_predictdb_from_QTLs.html">create_predictdb_from_QTLs()</a></code>. It will create PredictDB format weights, and save to the <code>outputdir</code> directory.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/create_predictdb_from_QTLs.html">create_predictdb_from_QTLs</a></span><span class="op">(</span><span class="va">weight_table</span>, </span>
<span>                           <span class="va">gene_table</span>, </span>
<span>                           use_top_QTL <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                           <span class="va">outputdir</span>, </span>
<span>                           <span class="va">outname</span><span class="op">)</span></span></code></pre></div>
<p><code>weight_table</code> is a data frame of the QTLs in the following format and with the required columns (“gene”, “rsid”, “varID”, “ref_allele”, “eff_allele”, “weight”):</p>
<pre><code><span><span class="st">"</span></span>
<span><span class="st">      gene        rsid                    varID   ref_allele eff_allele weight</span></span>
<span><span class="st">cg07570687  rs11190571  chr10_100472320_G_A_b38          G          A      1</span></span>
<span><span class="st">cg16342193   rs7070776  chr10_100504915_A_G_b38          A          G      1</span></span>
<span><span class="st">cg21542427   rs2495721  chr10_100614350_G_A_b38          G          A      1</span></span>
<span><span class="st">cg26540559   rs4917904  chr10_100687535_G_A_b38          G          A      1</span></span>
<span><span class="st">cg23069052 rs147983854 chr10_100717502_GC_G_b38         GC          G      1</span></span>
<span><span class="st">cg24179445  rs12268880  chr10_100735528_G_C_b38          G          C      1</span></span>
<span><span class="st">"</span></span></code></pre>
<p><code>gene_table</code> is an optional data frame in the following format with information of the genes (“gene”, “genename”, “gene_type”, etc.):</p>
<pre><code><span><span class="st">"</span></span>
<span><span class="st">      gene genename      gene_type</span></span>
<span><span class="st">cg19220149      A2M protein_coding</span></span>
<span><span class="st">cg06705064   A4GALT protein_coding</span></span>
<span><span class="st">cg25015779   A4GALT protein_coding</span></span>
<span><span class="st">cg08572757     AACS protein_coding</span></span>
<span><span class="st">cg06287003     AACS protein_coding</span></span>
<span><span class="st">cg26295774  AADACL2 protein_coding</span></span>
<span><span class="st">"</span></span></code></pre>
<p>When <code>use_top_QTL=TRUE</code>, it is limited to only one top eQTL per gene. If <code>weight_table</code> has more than one SNP per gene, it will select the top SNP with the largest <code>abs(weight)</code>. It will also create a simple covariance table with covariance set to 1, as each gene only has one top eQTL.</p>
<p>If you want to use multiple eQTLs per gene, you can set <code>use_top_QTL=FALSE</code>. In that case, we assume the weights of the eQTLs are learned from multiple regression (instead of marginal effect sizes).</p>
<p>If you use weights converted from <em>top</em> eQTLs, we set <code>load_predictdb_LD = TRUE</code> in the <code><a href="../reference/preprocess_weights.html">preprocess_weights()</a></code> function to load pre-computed correlations between variants. But for weights converted from multiple eQTLs per gene, you would still need to compute correlations between variants from the LD reference by setting <code>load_predictdb_LD = FALSE</code>. Also, we do not need to scale the weights, so we set <code>scale_predictdb_weights = FALSE</code>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Siming Zhao, Wesley Crouse, Sheng Qian, Kaixuan Luo, Matthew Stephens, Xin He.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
