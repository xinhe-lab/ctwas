<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Post-processing cTWAS results • ctwas</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Post-processing cTWAS results">
<meta property="og:description" content="ctwas">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ctwas</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.4.21</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Tutorial
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/minimal_tutorial.html">A minimal tutorial of running cTWAS without LD</a>
    </li>
    <li>
      <a href="../articles/preparing_input_data.html">Preparing cTWAS input data</a>
    </li>
    <li>
      <a href="../articles/running_ctwas_analysis.html">Running cTWAS analysis</a>
    </li>
    <li>
      <a href="../articles/summarizing_results.html">Summarizing and visualizing cTWAS results</a>
    </li>
    <li>
      <a href="../articles/sample_report.html">Sample report of cTWAS results</a>
    </li>
    <li>
      <a href="../articles/postprocessing.html">Post-processing cTWAS results</a>
    </li>
    <li>
      <a href="../articles/utility_functions.html">cTWAS utility functions</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/FAQ.html">FAQ</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/software_updates.html">Software updates</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/xinhe-lab/ctwas/tree/multigroup" class="external-link">Source</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="postprocessing_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Post-processing cTWAS results</h1>
                        <h4 data-toc-skip class="author">Kaixuan Luo, Sheng Qian</h4>
            
            <h4 data-toc-skip class="date">2024-12-18</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/xinhe-lab/ctwas/blob/multigroup/vignettes/postprocessing.Rmd" class="external-link"><code>vignettes/postprocessing.Rmd</code></a></small>
      <div class="hidden name"><code>postprocessing.Rmd</code></div>

    </div>

    
    
<p>A few issues can potentially lead to problematic results by cTWAS. In this tutorial, we will show how to address these issues by performing post-processing of cTWAS results.</p>
<p>Load the packages.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/xinhe-lab/ctwas/" class="external-link">ctwas</a></span><span class="op">)</span></span></code></pre></div>
<p>Let’s first load the cTWAS input data needed to run this tutorial: GWAS sample size (<code>gwas_n</code>), preprocessed GWAS z-scores (<code>z_snp</code>), prediction models of molecular traits (<code>weights</code>), and the reference data: including information about regions (<code>region_info</code>), reference variant list (<code>snp_map</code>).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gwas_n</span> <span class="op">&lt;-</span> <span class="fl">343621</span></span>
<span></span>
<span><span class="va">z_snp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/sample_data"</span>, <span class="st">"LDL_example.preprocessed.z_snp.RDS"</span>, package <span class="op">=</span> <span class="st">"ctwas"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/sample_data"</span>, <span class="st">"LDL_example.preprocessed.weights.RDS"</span>, package <span class="op">=</span> <span class="st">"ctwas"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">region_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/sample_data"</span>, <span class="st">"LDL_example.region_info.RDS"</span>, package <span class="op">=</span> <span class="st">"ctwas"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">snp_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/sample_data"</span>, <span class="st">"LDL_example.snp_map.RDS"</span>, package <span class="op">=</span> <span class="st">"ctwas"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>When running with LD, we load the cTWAS result from running the <code><a href="../reference/ctwas_sumstats.html">ctwas_sumstats()</a></code> function. We also load reference LD (<code>LD_map</code>) and the directory where we save the correlation matrices.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctwas_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/sample_data"</span>, <span class="st">"LDL_example.ctwas_sumstats_res.RDS"</span>, package <span class="op">=</span> <span class="st">"ctwas"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">z_gene</span> <span class="op">&lt;-</span> <span class="va">ctwas_res</span><span class="op">$</span><span class="va">z_gene</span></span>
<span><span class="va">param</span> <span class="op">&lt;-</span> <span class="va">ctwas_res</span><span class="op">$</span><span class="va">param</span></span>
<span><span class="va">finemap_res</span> <span class="op">&lt;-</span> <span class="va">ctwas_res</span><span class="op">$</span><span class="va">finemap_res</span></span>
<span><span class="va">boundary_genes</span> <span class="op">&lt;-</span> <span class="va">ctwas_res</span><span class="op">$</span><span class="va">boundary_genes</span></span>
<span><span class="va">region_data</span> <span class="op">&lt;-</span> <span class="va">ctwas_res</span><span class="op">$</span><span class="va">region_data</span></span>
<span><span class="va">screen_res</span> <span class="op">&lt;-</span> <span class="va">ctwas_res</span><span class="op">$</span><span class="va">screen_res</span></span>
<span></span>
<span><span class="va">LD_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/sample_data"</span>, <span class="st">"LDL_example.LD_map.RDS"</span>, package <span class="op">=</span> <span class="st">"ctwas"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cor_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/sample_data"</span>, <span class="st">"cor_matrix"</span>, package <span class="op">=</span> <span class="st">"ctwas"</span><span class="op">)</span></span></code></pre></div>
<p>When running without LD, we load the cTWAS result from running the <code><a href="../reference/ctwas_sumstats_noLD.html">ctwas_sumstats_noLD()</a></code> function:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctwas_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/sample_data"</span>, <span class="st">"LDL_example.ctwas_sumstats_noLD_res.RDS"</span>, package <span class="op">=</span> <span class="st">"ctwas"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">z_gene</span> <span class="op">&lt;-</span> <span class="va">ctwas_res</span><span class="op">$</span><span class="va">z_gene</span></span>
<span><span class="va">param</span> <span class="op">&lt;-</span> <span class="va">ctwas_res</span><span class="op">$</span><span class="va">param</span></span>
<span><span class="va">finemap_res</span> <span class="op">&lt;-</span> <span class="va">ctwas_res</span><span class="op">$</span><span class="va">finemap_res</span></span>
<span><span class="va">boundary_genes</span> <span class="op">&lt;-</span> <span class="va">ctwas_res</span><span class="op">$</span><span class="va">boundary_genes</span></span>
<span><span class="va">region_data</span> <span class="op">&lt;-</span> <span class="va">ctwas_res</span><span class="op">$</span><span class="va">region_data</span></span>
<span><span class="va">screen_res</span> <span class="op">&lt;-</span> <span class="va">ctwas_res</span><span class="op">$</span><span class="va">screen_res</span></span></code></pre></div>
<div class="section level2">
<h2 id="cross-region-ld">Cross-region LD<a class="anchor" aria-label="anchor" href="#cross-region-ld"></a>
</h2>
<p>If the variants in a prediction model of a gene (or molecular trait) span two (or more) regions, it would be unclear to cTWAS what region the gene should be assigned to. If this happens, cTWAS will attempt to assign the gene to one of the two regions that contain most of the weights. Nevertheless, there will be a risk of cross-region LD, where the genetic component of this gene may correlate with variants or genes of both regions. This violates the assumption of cTWAS and can lead to false positive findings.</p>
<p>We address this “cross-region” problem by performing “region merging” as a post-processing step. If any gene has variants in the weights that span two or more regions (“cross-boundary”), those regions will be merged, and cTWAS will rerun the fine-mapping step on the merged regions.</p>
<p>We first select the genes to merge. This could be all genes whose weights span two or more regions. In practice, the genes that are unlikely to be causal for the phenotype generally wouldn’t cause problems. So we can limit to the cross-boundary genes that are plausible risk genes. The results of cTWAS contain the list of genes with cross-boundary weights, <code>boundary_genes</code>. We can then select among these genes, the ones above a PIP cutoff and in credible sets.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">high_PIP_finemap_gene_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">finemap_res</span>, <span class="va">group</span> <span class="op">!=</span> <span class="st">"SNP"</span> <span class="op">&amp;</span> <span class="va">susie_pip</span> <span class="op">&gt;</span> <span class="fl">0.5</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">cs</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">high_PIP_genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">high_PIP_finemap_gene_res</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span></span>
<span><span class="va">selected_boundary_genes</span> <span class="op">&lt;-</span> <span class="va">boundary_genes</span><span class="op">[</span><span class="va">boundary_genes</span><span class="op">$</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">high_PIP_genes</span>, , drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span></span></code></pre></div>
<div class="section level3">
<h3 id="merge-regions">Merge regions<a class="anchor" aria-label="anchor" href="#merge-regions"></a>
</h3>
<p>Next, we use the function <code><a href="../reference/merge_region_data.html">merge_region_data()</a></code> to perform region merging. It first identifies overlapping regions from the selected genes, then creates the data about the merged region(s) needed for fine-mapping. The data includes: <code>merged_region_data</code>, <code>merged_region_info</code>, and the variant and LD information of the merged region(s), <code>merged_snp_map</code> and <code>merged_LD_map</code>. The function expands the merged regions with all SNPs if the <code>region_data</code> contains thinned SNPs. It also creates <code>merged_region_id_map</code>, a data frame containing region IDs for merged regions and the original region IDs, so that one could keep track of the regions that were merged.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="va">merge_region_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge_region_data.html">merge_region_data</a></span><span class="op">(</span><span class="va">selected_boundary_genes</span>,</span>
<span>                                       <span class="va">region_data</span>,</span>
<span>                                       region_info <span class="op">=</span> <span class="va">region_info</span>,</span>
<span>                                       LD_map <span class="op">=</span> <span class="va">LD_map</span>,</span>
<span>                                       snp_map <span class="op">=</span> <span class="va">snp_map</span>,</span>
<span>                                       weights <span class="op">=</span> <span class="va">weights</span>,</span>
<span>                                       z_snp <span class="op">=</span> <span class="va">z_snp</span>,</span>
<span>                                       z_gene <span class="op">=</span> <span class="va">z_gene</span>,</span>
<span>                                       estimate_L <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                       maxSNP <span class="op">=</span> <span class="fl">20000</span><span class="op">)</span></span>
<span><span class="va">merged_region_data</span> <span class="op">&lt;-</span> <span class="va">merge_region_res</span><span class="op">$</span><span class="va">merged_region_data</span></span>
<span><span class="va">merged_region_info</span> <span class="op">&lt;-</span> <span class="va">merge_region_res</span><span class="op">$</span><span class="va">merged_region_info</span></span>
<span><span class="va">merged_LD_map</span> <span class="op">&lt;-</span> <span class="va">merge_region_res</span><span class="op">$</span><span class="va">merged_LD_map</span></span>
<span><span class="va">merged_snp_map</span> <span class="op">&lt;-</span> <span class="va">merge_region_res</span><span class="op">$</span><span class="va">merged_snp_map</span></span>
<span><span class="va">merged_region_id_map</span> <span class="op">&lt;-</span> <span class="va">merge_region_res</span><span class="op">$</span><span class="va">merged_region_id_map</span></span>
<span><span class="va">merged_region_L</span> <span class="op">&lt;-</span> <span class="va">merge_region_res</span><span class="op">$</span><span class="va">merged_region_L</span></span></code></pre></div>
<p>When <code>estimate_L = TRUE</code>, we estimate the number of credible sets (<code>merged_region_L</code>) for the merged regions. This information will be used later in the fine-mapping step. We could set <code>maxSNP</code> to limit the number of SNPs in the region, if merged regions contain too many SNPs,</p>
<p>Next, we run fine-mapping again for these merged regions, similar to the section “Fine-mapping screened regions” in the tutorial <a href="https://xinhe-lab.github.io/multigroup_ctwas/articles/running_ctwas_analysis.html" class="external-link">“Running cTWAS analysis”</a>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">finemap_merged_regions_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/finemap_regions.html">finemap_regions</a></span><span class="op">(</span><span class="va">merged_region_data</span>,</span>
<span>                                              LD_map <span class="op">=</span> <span class="va">merged_LD_map</span>,</span>
<span>                                              weights <span class="op">=</span> <span class="va">weights</span>,</span>
<span>                                              group_prior <span class="op">=</span> <span class="va">group_prior</span>,</span>
<span>                                              group_prior_var <span class="op">=</span> <span class="va">group_prior_var</span>,</span>
<span>                                              L <span class="op">=</span> <span class="va">merged_region_L</span>,</span>
<span>                                              save_cor <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                              cor_dir <span class="op">=</span> <span class="st">"./cor_matrix"</span><span class="op">)</span></span></code></pre></div>
<p>The output of this function has the same format as those from regular cTWAS analysis. It returns fine-mapping results for merged regions.</p>
</div>
<div class="section level3">
<h3 id="merge-regions-without-ld">Merge regions without LD<a class="anchor" aria-label="anchor" href="#merge-regions-without-ld"></a>
</h3>
<p>When running cTWAS without LD, we can do region merging using the function <code><a href="../reference/merge_region_data_noLD.html">merge_region_data_noLD()</a></code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">merge_region_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge_region_data_noLD.html">merge_region_data_noLD</a></span><span class="op">(</span><span class="va">selected_boundary_genes</span>,</span>
<span>                                           <span class="va">region_data</span>,</span>
<span>                                           region_info <span class="op">=</span> <span class="va">region_info</span>,</span>
<span>                                           snp_map <span class="op">=</span> <span class="va">snp_map</span>,</span>
<span>                                           z_snp <span class="op">=</span> <span class="va">z_snp</span>,</span>
<span>                                           z_gene <span class="op">=</span> <span class="va">z_gene</span>,</span>
<span>                                           maxSNP <span class="op">=</span> <span class="fl">20000</span><span class="op">)</span></span>
<span><span class="va">merged_region_data</span> <span class="op">&lt;-</span> <span class="va">merge_region_res</span><span class="op">$</span><span class="va">merged_region_data</span></span>
<span><span class="va">merged_region_info</span> <span class="op">&lt;-</span> <span class="va">merge_region_res</span><span class="op">$</span><span class="va">merged_region_info</span></span>
<span><span class="va">merged_snp_map</span> <span class="op">&lt;-</span> <span class="va">merge_region_res</span><span class="op">$</span><span class="va">merged_snp_map</span></span>
<span><span class="va">merged_region_id_map</span> <span class="op">&lt;-</span> <span class="va">merge_region_res</span><span class="op">$</span><span class="va">merged_region_id_map</span></span></code></pre></div>
<p>We can then run fine-mapping (without LD) on the merged region data:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">finemap_merged_regions_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/finemap_regions_noLD.html">finemap_regions_noLD</a></span><span class="op">(</span><span class="va">merged_region_data</span>,                                                     </span>
<span>                                                   group_prior <span class="op">=</span> <span class="va">group_prior</span>,</span>
<span>                                                   group_prior_var <span class="op">=</span> <span class="va">group_prior_var</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="update-fine-mapping-results-after-region-merging">Update fine-mapping results after region merging<a class="anchor" aria-label="anchor" href="#update-fine-mapping-results-after-region-merging"></a>
</h3>
<p>We can update the fine-mapping results after region merging:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_merged_region_finemap_res.html">update_merged_region_finemap_res</a></span><span class="op">(</span><span class="va">finemap_res</span>, </span>
<span>                                        <span class="va">susie_alpha_res</span>, </span>
<span>                                        <span class="va">merged_region_finemap_res</span>, </span>
<span>                                        <span class="va">merged_region_susie_alpha_res</span>,</span>
<span>                                        <span class="va">merged_region_id_map</span><span class="op">)</span></span>
<span><span class="va">updated_merged_finemap_res</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">finemap_res</span></span>
<span><span class="va">updated_merged_susie_alpha_res</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">susie_alpha_res</span></span></code></pre></div>
<p>After region merging, we can also update the region data (and other input data), which could be used in later, e.g. LD mismatch analysis:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">updated_data_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_merged_region_data.html">update_merged_region_data</a></span><span class="op">(</span><span class="va">region_data</span>, <span class="va">merged_region_data</span>,</span>
<span>                                              <span class="va">region_info</span>, <span class="va">merged_region_info</span>,</span>
<span>                                              <span class="va">LD_map</span>, <span class="va">merged_LD_map</span>,</span>
<span>                                              <span class="va">snp_map</span>, <span class="va">merged_snp_map</span>,</span>
<span>                                              <span class="va">screened_region_L</span>, <span class="va">merged_region_L</span>,</span>
<span>                                              <span class="va">merged_region_id_map</span><span class="op">)</span></span>
<span><span class="va">updated_region_data</span> <span class="op">&lt;-</span> <span class="va">updated_data_res</span><span class="op">$</span><span class="va">updated_region_data</span></span>
<span><span class="va">updated_region_info</span> <span class="op">&lt;-</span> <span class="va">updated_data_res</span><span class="op">$</span><span class="va">updated_region_info</span></span>
<span><span class="va">updated_LD_map</span> <span class="op">&lt;-</span> <span class="va">updated_data_res</span><span class="op">$</span><span class="va">updated_LD_map</span></span>
<span><span class="va">updated_snp_map</span> <span class="op">&lt;-</span> <span class="va">updated_data_res</span><span class="op">$</span><span class="va">updated_snp_map</span></span>
<span><span class="va">updated_region_L</span> <span class="op">&lt;-</span> <span class="va">updated_data_res</span><span class="op">$</span><span class="va">updated_region_L</span></span></code></pre></div>
<p>Similarly, we could update region data when running without LD:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">updated_data_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_merged_region_data_noLD.html">update_merged_region_data_noLD</a></span><span class="op">(</span><span class="va">region_data</span>, <span class="va">merged_region_data</span>,</span>
<span>                                                   <span class="va">region_info</span>, <span class="va">merged_region_info</span>,</span>
<span>                                                   <span class="va">snp_map</span>, <span class="va">merged_snp_map</span>,</span>
<span>                                                   <span class="va">merged_region_id_map</span><span class="op">)</span></span>
<span><span class="va">updated_region_data</span> <span class="op">&lt;-</span> <span class="va">updated_data_res</span><span class="op">$</span><span class="va">updated_region_data</span></span>
<span><span class="va">updated_region_info</span> <span class="op">&lt;-</span> <span class="va">updated_data_res</span><span class="op">$</span><span class="va">updated_region_info</span></span>
<span><span class="va">updated_snp_map</span> <span class="op">&lt;-</span> <span class="va">updated_data_res</span><span class="op">$</span><span class="va">updated_snp_map</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="dealing-with-ld-mismatch">Dealing with LD mismatch<a class="anchor" aria-label="anchor" href="#dealing-with-ld-mismatch"></a>
</h2>
<p>LD mismatch between GWAS data (in-sample LD) and the reference LD could lead to false positives in fine-mapping. Diagnostic tools including <a href="https://stephenslab.github.io/susieR/articles/susierss_diagnostic.html" class="external-link">SuSiE-RSS</a>, and <a href="https://github.com/Yves-CHEN/DENTIST/" class="external-link">DENTIST</a>, have been developed to check possible LD mismatch. Because it is very time consuming to run the LD mismatch diagnosis for all the regions across the genome, we will perform LD mismatch diagnosis and adjustment only for selected regions with high PIP signals in the post-processing.</p>
<p>Here, we perform the LD mismatch diagnosis using <a href="https://stephenslab.github.io/susieR/articles/susierss_diagnostic.html" class="external-link">SuSiE-RSS</a> for selected regions. It is an optional step that users could run after finishing the main cTWAS analysis. Users could choose regions of interest.</p>
<p>For example, we could use the function <code><a href="../reference/compute_region_nonSNP_PIPs.html">compute_region_nonSNP_PIPs()</a></code> to compute total non-SNP PIPs for the regions. The non-SNP PIP of a region is the sum of PIPs of all molecular traits in that region. We also limit to credible sets by setting <code>filter_cs = TRUE</code>. We can then select regions with total non-SNP PIPs &gt; 0.8 to run LD mismatch diagnosis:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nonSNP_PIPs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_region_nonSNP_PIPs.html">compute_region_nonSNP_PIPs</a></span><span class="op">(</span><span class="va">finemap_res</span>, filter_cs <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">selected_region_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">nonSNP_PIPs</span><span class="op">)</span><span class="op">[</span><span class="va">nonSNP_PIPs</span> <span class="op">&gt;</span> <span class="fl">0.8</span><span class="op">]</span></span></code></pre></div>
<p>We use the function <code><a href="../reference/diagnose_LD_mismatch_susie.html">diagnose_LD_mismatch_susie()</a></code> to perform LD mismatch diagnosis for these regions. This function uses <a href="https://stephenslab.github.io/susieR/articles/susierss_diagnostic.html" class="external-link">SuSiE-RSS</a> to detect problematic SNPs among all variants in a region. Basically, it infers the expected statistic of a variant, based on the statistics of nearby variants and their LD from the reference, and compares this with the observed statistic. Inconsistency between the two would suggest potential LD mismatch.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/diagnose_LD_mismatch_susie.html">diagnose_LD_mismatch_susie</a></span><span class="op">(</span>region_ids <span class="op">=</span> <span class="va">selected_region_ids</span>, </span>
<span>                                  z_snp <span class="op">=</span> <span class="va">z_snp</span>, </span>
<span>                                  LD_map <span class="op">=</span> <span class="va">LD_map</span>, </span>
<span>                                  gwas_n <span class="op">=</span> <span class="va">gwas_n</span>,</span>
<span>                                  p_diff_thresh <span class="op">=</span> <span class="fl">5e-8</span>,</span>
<span>                                  ncore <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">problematic_snps</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">problematic_snps</span></span>
<span><span class="va">flipped_snps</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">flipped_snps</span></span>
<span><span class="va">condz_stats</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">condz_stats</span></span></code></pre></div>
<p>This returns a list of problematic SNPs (diagnostic test <code>p-value &lt; 5e-8</code>, by default), flipped SNPs, and the test statistics of <code>kriging_rss</code> function from <a href="https://stephenslab.github.io/susieR/articles/susierss_diagnostic.html" class="external-link">SuSiE-RSS</a>.</p>
<p>Our basic strategy of dealing with LD mismatch is: we use the list of problematic SNPs to identify the molecular traits whose results may be affected by LD-mismatch. We would then run SuSiE fine-mapping with L = 1 in the regions containing these molecular traits, assuming a single causal signal in such a region. The fine-mapping results in this setting would be independent of LD.</p>
<p>We choose the genes with some plausibility of being risk genes (gene PIP &gt; 0.5 by default) and problematic SNPs in their weights. We would then select regions containing these problematic genes.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">problematic_genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_problematic_genes.html">get_problematic_genes</a></span><span class="op">(</span><span class="va">problematic_snps</span>, </span>
<span>                                           <span class="va">weights</span>, </span>
<span>                                           <span class="va">finemap_res</span>, </span>
<span>                                           pip_thresh <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">problematic_region_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">finemap_res</span><span class="op">[</span><span class="va">finemap_res</span><span class="op">$</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">problematic_genes</span>, <span class="st">"region_id"</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">finemap_res</span><span class="op">[</span><span class="va">finemap_res</span><span class="op">$</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">problematic_genes</span>,<span class="op">]</span></span></code></pre></div>
<p>We then rerun the fine-mapping without LD information for the problematic regions, using the <code><a href="../reference/finemap_regions_noLD.html">finemap_regions_noLD()</a></code> function:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">problematic_region_ids</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">rerun_region_data</span> <span class="op">&lt;-</span> <span class="va">screen_res</span><span class="op">$</span><span class="va">screened_region_data</span><span class="op">[</span><span class="va">problematic_region_ids</span><span class="op">]</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/finemap_regions_noLD.html">finemap_regions_noLD</a></span><span class="op">(</span><span class="va">rerun_region_data</span>, </span>
<span>                              group_prior <span class="op">=</span> <span class="va">group_prior</span>,</span>
<span>                              group_prior_var <span class="op">=</span> <span class="va">group_prior_var</span><span class="op">)</span></span>
<span>  <span class="va">rerun_finemap_res</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">finemap_res</span></span>
<span>  <span class="va">rerun_susie_alpha_res</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">susie_alpha_res</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We can check the fine-mapping results (without LD) for the problematic genes:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rerun_finemap_res</span><span class="op">[</span><span class="va">rerun_finemap_res</span><span class="op">$</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">problematic_genes</span>,<span class="op">]</span></span></code></pre></div>
<p>We can update the fine-mapping results for the problematic regions:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_finemap_res.html">update_finemap_res</a></span><span class="op">(</span><span class="va">finemap_res</span>, </span>
<span>                          <span class="va">susie_alpha_res</span>, </span>
<span>                          <span class="va">rerun_finemap_res</span>, </span>
<span>                          <span class="va">rerun_susie_alpha_res</span>,</span>
<span>                          updated_region_ids <span class="op">=</span> <span class="va">problematic_region_ids</span><span class="op">)</span></span>
<span><span class="va">updated_finemap_res</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">finemap_res</span></span>
<span><span class="va">updated_susie_alpha_res</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">susie_alpha_res</span></span></code></pre></div>
<p>In practice, it could be helpful to first run region merging, and then perform the LD-mismatch analysis. We could first update the region data after region merging, and then run LD-mismatch analysis using the updated region data.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Siming Zhao, Wesley Crouse, Sheng Qian, Kaixuan Luo, Matthew Stephens, Xin He.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
