<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Running cTWAS analysis • ctwas</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Running cTWAS analysis">
<meta property="og:description" content="ctwas">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ctwas</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.4.21</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Tutorial
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/minimal_tutorial.html">A minimal tutorial of running cTWAS without LD</a>
    </li>
    <li>
      <a href="../articles/preparing_input_data.html">Preparing cTWAS input data</a>
    </li>
    <li>
      <a href="../articles/running_ctwas_analysis.html">Running cTWAS analysis</a>
    </li>
    <li>
      <a href="../articles/summarizing_results.html">Summarizing and visualizing cTWAS results</a>
    </li>
    <li>
      <a href="../articles/sample_report.html">Sample report of cTWAS results</a>
    </li>
    <li>
      <a href="../articles/postprocessing.html">Post-processing cTWAS results</a>
    </li>
    <li>
      <a href="../articles/utility_functions.html">cTWAS utility functions</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/FAQ.html">FAQ</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/software_updates.html">Software updates</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/xinhe-lab/ctwas/tree/multigroup" class="external-link">Source</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="running_ctwas_analysis_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Running cTWAS analysis</h1>
                        <h4 data-toc-skip class="author">Kaixuan Luo, Sheng Qian</h4>
            
            <h4 data-toc-skip class="date">2024-12-18</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/xinhe-lab/ctwas/blob/multigroup/vignettes/running_ctwas_analysis.Rmd" class="external-link"><code>vignettes/running_ctwas_analysis.Rmd</code></a></small>
      <div class="hidden name"><code>running_ctwas_analysis.Rmd</code></div>

    </div>

    
    
<p>Running cTWAS analysis involves several major steps: preparing input data, computing associations of molecular traits with the phenotype, estimating parameters, screening for candidate genomic regions, and fine-mapping these regions.</p>
<p>In this version of cTWAS, we allow the joint analysis of multiple groups of molecular traits. This could be: eQTL of multiple tissues; or eQTLs, splicing QTLs and other types of QTLs in a single tissue. In a more complex setting, multiple types of QTL data from multiple tissues/cell types. Each group is defined by its “type” (kind of molecular traits), and “context” (tissue, cell type, condition, etc.).</p>
<p>We require first running the data preprocessing and harmonization steps. Please follow the <a href="https://xinhe-lab.github.io/multigroup_ctwas/articles/preparing_input_data.html" class="external-link">“Preparing cTWAS input data”</a> tutorial.</p>
<p>Load the packages</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/xinhe-lab/ctwas/" class="external-link">ctwas</a></span><span class="op">)</span></span></code></pre></div>
<p>Let’s first load the preprocessed input data,including GWAS summary statistics (<code>z_snp</code>), the processed weights of molecular traits (<code>weights</code>), the region definitions (<code>region_info</code>), and the list of SNPs and information of LD matrix of each region (<code>snp_map</code> and <code>LD_map</code>):</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">z_snp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/sample_data"</span>, <span class="st">"LDL_example.preprocessed.z_snp.RDS"</span>, package <span class="op">=</span> <span class="st">"ctwas"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/sample_data"</span>, <span class="st">"LDL_example.preprocessed.weights.RDS"</span>, package <span class="op">=</span> <span class="st">"ctwas"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">region_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/sample_data"</span>, <span class="st">"LDL_example.region_info.RDS"</span>, package <span class="op">=</span> <span class="st">"ctwas"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">snp_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/sample_data"</span>, <span class="st">"LDL_example.snp_map.RDS"</span>, package <span class="op">=</span> <span class="st">"ctwas"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">LD_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/sample_data"</span>, <span class="st">"LDL_example.LD_map.RDS"</span>, package <span class="op">=</span> <span class="st">"ctwas"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We have two ways of running cTWAS main analysis: running the main function, or running separate modules. The first is easier to run, and the second has the advantage of giving you more control of the analysis (see below).</p>
<div class="section level2">
<h2 id="running-ctwas-main-function">Running cTWAS main function<a class="anchor" aria-label="anchor" href="#running-ctwas-main-function"></a>
</h2>
<p>In this section, we will show how to perform full cTWAS analysis using the main function.</p>
<p>We use the function <code><a href="../reference/ctwas_sumstats.html">ctwas_sumstats()</a></code> to run cTWAS analysis with LD. It takes as input preprocessed GWAS z-scores (<code>z_snp</code>), and prediction models of molecular traits (<code>weights</code>). In addition, it requires the reference data including information about regions (<code>region_info</code>), reference variant list (<code>snp_map</code>) and reference LD (<code>LD_map</code>).</p>
<p>The function performs the main steps: (i) computing Z-scores of molecular traits; (i) estimating model parameters; (iii) screening regions potentially containing causal molecular traits, and (iv) fine-mapping those regions to discover causal molecular traits.</p>
<p>Now, we can run cTWAS using the <code><a href="../reference/ctwas_sumstats.html">ctwas_sumstats()</a></code> function:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctwas_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ctwas_sumstats.html">ctwas_sumstats</a></span><span class="op">(</span><span class="va">z_snp</span>, </span>
<span>                            <span class="va">weights</span>, </span>
<span>                            <span class="va">region_info</span>, </span>
<span>                            <span class="va">LD_map</span>, </span>
<span>                            <span class="va">snp_map</span>, </span>
<span>                            thin <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>                            maxSNP <span class="op">=</span> <span class="fl">20000</span>,</span>
<span>                            min_group_size <span class="op">=</span> <span class="fl">100</span>, </span>
<span>                            group_prior_var_structure <span class="op">=</span> <span class="st">"shared_type"</span>, </span>
<span>                            filter_L <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                            filter_nonSNP_PIP <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                            min_nonSNP_PIP <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>                            min_abs_corr <span class="op">=</span> <span class="fl">0.1</span>, </span>
<span>                            ncore <span class="op">=</span> <span class="fl">6</span>, </span>
<span>                            ncore_LD <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                            save_cor <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                            cor_dir <span class="op">=</span> <span class="st">"./cor_matrix"</span>,</span>
<span>                            force_compute_cor <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Important arguments that control how this function is executed:</p>
<ul>
<li><p><code>z_gene</code>: computed Z-scores of the molecular traits. If not provided, it will compute those using <code>z_snp</code> and <code>weights</code>.</p></li>
<li><p><code>thin</code>: the fraction of SNPs used to estimate parameters and screen regions likely containing signals. By sampling a fraction of SNPs, this speeds up computation. By default, we use <code>thin = 0.1</code>, i.e. 10% of the SNPs. To use all SNPs in parameter estimation and screening regions, one could change the <code>thin</code> parameter to 1.</p></li>
<li><p><code>maxSNP</code>: maximum number of SNPs in a region (e.g. 20000). Default is Inf, no limit. This can be useful if there are too many SNPs in a region and you don’t have enough memory to run the program.</p></li>
<li><p><code>min_group_size</code>: minimum number of variables in a region (default is 100). Groups with fewer variables will be removed from cTWAS analysis, because parameters cannot be reliably estimated for groups with too few variables.</p></li>
<li><p><code>group_prior_var_stucture</code>: options to control how the effect size variance parameters are shared among groups. For example, “shared_type” (default option) allows all groups in one molecular QTL type to share the same variance parameter. “independent” allows all groups to have their own separate variance parameters. More options can be found in the “Estimating parameters” section below.</p></li>
<li><p><code>filter_L</code>: if <code>filter_L = TRUE</code> (the default option), cTWAS will first estimate the number of causal signals (<code>L</code>) for each region. This step is done using uniform prior, treating all variants and genes equally. From the results, we obtain the number of credible sets (<code>L</code>). We then select regions with at least one credible set, L &gt; 0.</p></li>
<li><p><code>filter_nonSNP_PIP</code> and <code>min_nonSNP_PIP</code>: if <code>filter_nonSNP_PIP = TRUE</code>, it will compute the non-SNP PIP, i.e. the total PIP of all molecular traits, for each region (using the estimated parameters) and select regions with non-SNP PIP &gt; <code>min_nonSNP_PIP</code> (0.5 by default).</p></li>
<li><p><code>min_abs_corr</code>: Minimum absolute correlation allowed in a credible set. cTWAS jointly fine-maps both SNPs and molecular traits, the correlations between SNPs and molecular traits could be lower than standard fine-mapping with SNPs. We use a lower cutoff (0.1 by default).</p></li>
<li><p><code>ncore</code>: computation of genomic regions can be performed in parallel. This parameter controls how many cores are used in the parallelization.</p></li>
<li><p><code>ncore_LD</code>: this sets the number of cores in parallelization when LD matrices are needed. In screening regions and fine-mapping steps, we need larger memory to load and process LD matrices. We recommend using fewer cores in <code>ncore_LD</code> than <code>ncore</code>.</p></li>
<li><p><code>cor_dir</code>, <code>save_cor</code>, and <code>force_compute_cor</code>: we need correlation matrices during fine-mapping and visualizing the results with LD. If <code>cor_dir</code> is provided, cTWAS will check the <code>cor_dir</code> directory. If precomputed correlation matrices are available in <code>cor_dir</code>, cTWAS will simply load those. Otherwise, it will compute the correlation matrices and save to the <code>cor_dir</code> directory if <code>save_cor = TRUE</code>. You can set <code>force_compute_cor = TRUE</code> so that it always computes the correlation matrices. The correlation matrices are large datasets, so they are not saved by default. <em>Note</em>: you should use a different <code>cor_dir</code> directory for each cTWAS analysis; otherwise, it would cause mismatch between Z-scores and correlation matrices in the old <code>cor_dir</code>.</p></li>
</ul>
<p>To understand and summarize the results from cTWAS, please read the tutorial <a href="https://xinhe-lab.github.io/multigroup_ctwas/articles/summarizing_results.html" class="external-link">“Summarizing and visualizing cTWAS results”</a>.</p>
<p><em>Note:</em> One can run cTWAS without using reference LD data. See <a href="https://xinhe-lab.github.io/multigroup_ctwas/articles/minimal_tutorial.html" class="external-link">“A minimal tutorial of running cTWAS without LD”</a>. That tutorial describes how to run cTWAS in a single step.</p>
</div>
<div class="section level2">
<h2 id="running-ctwas-modules">Running cTWAS modules<a class="anchor" aria-label="anchor" href="#running-ctwas-modules"></a>
</h2>
<p>This section describes how to perform cTWAS analysis by running each of the modules separately. This would allow more flexible controls of the cTWAS modules, e.g. running each module with different settings (memory, parallelization, etc.). We could also save the results from each module for future access, that way, we can re-run just one module, if necessary, without running the entire process. One useful way of running cTWAS is to first run the first few steps to estimate model parameters and assess their values. If this step does not converge, or the parameters look strange, it is best to pause and understand why.</p>
<p>We note that one can also run cTWAS without using LD information - see the tutorial <a href="https://xinhe-lab.github.io/multigroup_ctwas/articles/minimal_tutorial.html" class="external-link">“A minimal tutorial of running cTWAS without LD”</a>. It is also possible to do this analysis one step at a time. We describe below how each step can be done in appropriate places.</p>
<div class="section level3">
<h3 id="computing-z-scores-of-molecular-traits">Computing Z-scores of molecular traits<a class="anchor" aria-label="anchor" href="#computing-z-scores-of-molecular-traits"></a>
</h3>
<p>After we have done data preprocessing, we compute Z-scores of molecular traits. This step basically performs transcriptome-wide association studies (TWAS) on each molecular trait with a prediction model. The underlying calculation is based on <a href="https://www.nature.com/articles/s41467-018-03621-1" class="external-link">S-PrediXcan</a>.</p>
<p>The <code>compute_gene_z</code> function computes Z-scores for the molecular traits using preprocessed SNP Z-scores (<code>z_snp</code>) and the preprocessed weights (<code>weights</code>). <code>ncore</code> specifies the number of cores to use when parallelizing over genes.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">z_gene</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_gene_z.html">compute_gene_z</a></span><span class="op">(</span><span class="va">z_snp</span>, <span class="va">weights</span>, ncore <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span></code></pre></div>
<p>We recommend filtering out groups with too few variables (molecular traits), as parameters cannot be reliably estimated for groups with too few variables.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">z_gene</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filter_z_gene_by_group_size.html">filter_z_gene_by_group_size</a></span><span class="op">(</span><span class="va">z_gene</span>, min_group_size <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="assemble-input-data-for-the-regions">Assemble input data for the regions<a class="anchor" aria-label="anchor" href="#assemble-input-data-for-the-regions"></a>
</h3>
<p>Because cTWAS runs region-by-region, we will first need to prepare the data for each region, combining information of all variants and molecular traits in that region. After data preprocessing and computation of Z-scores of molecular traits, we assemble the input data for all the regions using the function <code><a href="../reference/assemble_region_data.html">assemble_region_data()</a></code>. It assigns molecular traits, variants and their Z-scores to each region. The assignment of a molecular trait to regions is based on the weights, i.e. variants in the prediction model, of the molecular trait.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/assemble_region_data.html">assemble_region_data</a></span><span class="op">(</span><span class="va">region_info</span>, </span>
<span>                            <span class="va">z_snp</span>, </span>
<span>                            <span class="va">z_gene</span>, </span>
<span>                            <span class="va">weights</span>, </span>
<span>                            <span class="va">snp_map</span>,</span>
<span>                            thin <span class="op">=</span> <span class="fl">0.1</span>, </span>
<span>                            maxSNP <span class="op">=</span> <span class="fl">20000</span>,</span>
<span>                            min_group_size <span class="op">=</span> <span class="fl">100</span>, </span>
<span>                            ncore <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span><span class="va">region_data</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">region_data</span></span>
<span><span class="va">boundary_genes</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">boundary_genes</span></span></code></pre></div>
<p>The function has a few arguments to control its behavior. The <code>thin</code> argument randomly selects a subset of variants (10% when thin = 0.1) to use during parameter estimation and screening for candidate regions. This helps reduce computation. If <code>thin = 1</code>, it will use all the SNPs. <code>maxSNP</code> sets a maximum on the number of variants that can be in a single region to prevent memory issues during fine-mapping. If the number of SNPs in a region is more than <code>maxSNP</code>, It will choose <code>maxSNP</code> SNPs (randomly, by default) in the region. <code>min_group_size</code> sets the minimum number of variables in a group. Groups with fewer variables will be removed from the analysis, because cTWAS cannot reliably estimate parameters for groups with too few variables. <code>ncore</code> specifies the number of cores to use when parallelizing over regions.</p>
<p>This function returns <code>region_data</code>, a list object containing input data (IDs of molecular traits and variants, their Z-scores, genomic boundaries, etc.) for each of the regions. It also returns a data frame <code>boundary_genes</code>, containing the information of molecular traits whose weights cross region boundaries. The information would be used in later analysis and post-processing.</p>
</div>
<div class="section level3">
<h3 id="estimating-parameters">Estimating parameters<a class="anchor" aria-label="anchor" href="#estimating-parameters"></a>
</h3>
<p>We use the <code><a href="../reference/est_param.html">est_param()</a></code> function to estimate two sets of parameters: the prior inclusion probabilities and the prior effect size variance for molecular traits and variants, separately.</p>
<p>As described in the Introduction, cTWAS can analyze multiple groups of molecular traits. This step will estimate the prior parameters for each group. But we allow sharing of the prior effect variance parameters among groups. This may improve the accuracy of parameter estimation.There are several options to control how parameters are shared among groups. This can be done by specifying the <code>group_prior_var_stucture</code>:</p>
<ul>
<li>“shared_type” (default option) allows all groups in one molecular QTL type to share the same variance parameter.</li>
<li>“shared_context” allows all groups in one context (tissue, cell type, condition) to share the same variance parameter.</li>
<li>“shared_nonSNP” allows all non-SNP groups (i.e. all molecular traits) to share the same variance parameter.</li>
<li>“shared_all” allows all groups, including SNPs, to share the same variance parameter.</li>
<li>“independent” allows all groups to have their own separate variance parameters.</li>
</ul>
<p>This step will run the EM algorithm to estimate parameters and return the estimated parameters (<code>group_prior</code>, <code>group_prior_var</code>, etc.). For technical reasons (see Methods of the cTWAS paper), it will run two rounds of EM algorithm. In the first round, it uses fewer iterations (<code>niter_prefit=3</code> by default) to get rough parameter estimates, and using these values, select regions for the analysis in the second run of EM. We use more iterations in the second round (<code>niter=30</code> by default) to get accurate parameter estimates. <code>min_group_size</code> sets the minimum number of variables in a group, as parameters cannot be reliably estimated for groups with too few variables.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">param</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/est_param.html">est_param</a></span><span class="op">(</span><span class="va">region_data</span>, </span>
<span>                   group_prior_var_structure <span class="op">=</span> <span class="st">"shared_type"</span>, </span>
<span>                   niter_prefit <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                   niter <span class="op">=</span> <span class="fl">30</span>, </span>
<span>                   min_group_size <span class="op">=</span> <span class="fl">100</span>,</span>
<span>                   ncore <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span><span class="va">group_prior</span> <span class="op">&lt;-</span> <span class="va">param</span><span class="op">$</span><span class="va">group_prior</span></span>
<span><span class="va">group_prior_var</span> <span class="op">&lt;-</span> <span class="va">param</span><span class="op">$</span><span class="va">group_prior_var</span></span></code></pre></div>
<p><em>Note</em>: we used sample data (from chr16) in this example, however, in real data analysis, parameter estimation should be done using data from the <em>entire genome</em>.</p>
</div>
<div class="section level3">
<h3 id="screening-regions">Screening regions<a class="anchor" aria-label="anchor" href="#screening-regions"></a>
</h3>
<div class="section level4">
<h4 id="screening-regions-with-ld">Screening regions with LD<a class="anchor" aria-label="anchor" href="#screening-regions-with-ld"></a>
</h4>
<p>After parameter estimation, we use the <code><a href="../reference/screen_regions.html">screen_regions()</a></code> function to perform a screening process to select regions with likely causal signals in molecular traits. To find these regions, we perform an initial fine-mapping with thinned SNPs (a subset of all variants, see the Section “Assemble input data”). Only these regions would be subject to full fine-mapping analysis, using all variants, in the final step. Thus screening regions can save computational time.</p>
<p>cTWAS have two options to screen regions: 1) screening by the number of causal signals, 2) screening by non-SNP PIPs.</p>
<p>Option 1: screening by the number of causal signals. If <code>filter_L = TRUE</code> and <code>filter_nonSNP_PIP = FALSE</code> (the default option), cTWAS will estimate the number of causal signals (<code>L</code>) for each region. This step is done by running fine-mapping using uniform prior, treating all variants and molecular traits equally. To use uniform prior, we set <code>group_prior = NULL</code> (uniform prior inclusion probabilities) and <code>group_prior_var = NULL</code> (prior variance = 50 as the default in <code>susie_rss</code>). From the results, we obtain the number of credible sets (<code>L</code>). We then select regions with at least one credible set, L &gt; 0.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">screen_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/screen_regions.html">screen_regions</a></span><span class="op">(</span><span class="va">region_data</span>,</span>
<span>                             LD_map <span class="op">=</span> <span class="va">LD_map</span>,</span>
<span>                             weights <span class="op">=</span> <span class="va">weights</span>, </span>
<span>                             filter_L <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                             filter_nonSNP_PIP <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                             min_abs_corr <span class="op">=</span> <span class="fl">0.1</span>, </span>
<span>                             group_prior <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                             group_prior_var <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                             ncore <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">screened_region_data</span> <span class="op">&lt;-</span> <span class="va">screen_res</span><span class="op">$</span><span class="va">screened_region_data</span></span>
<span><span class="va">screened_region_L</span> <span class="op">&lt;-</span> <span class="va">screen_res</span><span class="op">$</span><span class="va">screened_region_L</span></span>
<span><span class="va">screen_summary</span> <span class="op">&lt;-</span> <span class="va">screen_res</span><span class="op">$</span><span class="va">screen_summary</span></span></code></pre></div>
<p>It returns <code>screened_region_data</code> which contains a subset of region data for selected regions. It also returns the estimated L (number of credible sets) for the selected regions, which could be used in the fine-mapping step to set L for each region. In addition, it returns a data frame <code>screen_summary</code>, which includes the estimated L and non-SNP PIPs for all the regions.</p>
<p>Note: cTWAS jointly fine-maps both SNPs and molecular traits, the correlations between SNPs and molecular traits could be lower than standard fine-mapping with SNPs. Thus, we set a lower purity cutoff (default option: <code>min_abs_corr = 0.1</code>) for obtaining credible sets to avoid missing causal genes.</p>
<p>Option 2: screening by non-SNP PIPs. If <code>filter_nonSNP_PIP = TRUE</code> and <code>filter_L = FALSE</code>, cTWAS will compute the non-SNP PIP, i.e. total PIP of all molecular traits, for each region (using estimated priors). It then selects regions by applying a <code>min_nonSNP_PIP</code> cutoff (0.5, by default).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">screen_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/screen_regions.html">screen_regions</a></span><span class="op">(</span><span class="va">region_data</span>,</span>
<span>                             LD_map <span class="op">=</span> <span class="va">LD_map</span>,</span>
<span>                             weights <span class="op">=</span> <span class="va">weights</span>, </span>
<span>                             filter_L <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                             filter_nonSNP_PIP <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                             group_prior <span class="op">=</span> <span class="va">group_prior</span>,</span>
<span>                             group_prior_var <span class="op">=</span> <span class="va">group_prior_var</span>,</span>
<span>                             ncore <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">screened_region_data</span> <span class="op">&lt;-</span> <span class="va">screen_res</span><span class="op">$</span><span class="va">screened_region_data</span></span>
<span><span class="va">screened_region_L</span> <span class="op">&lt;-</span> <span class="va">screen_res</span><span class="op">$</span><span class="va">screened_region_L</span></span>
<span><span class="va">screen_summary</span> <span class="op">&lt;-</span> <span class="va">screen_res</span><span class="op">$</span><span class="va">screen_summary</span></span></code></pre></div>
<p>In general, we recommend screening by the number of causal signals, i.e. setting <code>filter_L = TRUE</code> and <code>filter_nonSNP_PIP = FALSE</code>.</p>
</div>
<div class="section level4">
<h4 id="screening-regions-without-ld">Screening regions without LD<a class="anchor" aria-label="anchor" href="#screening-regions-without-ld"></a>
</h4>
<p>When running without LD, we could use the <code><a href="../reference/screen_regions_noLD.html">screen_regions_noLD()</a></code> function; it would only perform screening regions by non-SNP PIPs.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">screen_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/screen_regions_noLD.html">screen_regions_noLD</a></span><span class="op">(</span><span class="va">region_data</span>,</span>
<span>                                  group_prior <span class="op">=</span> <span class="va">group_prior</span>,</span>
<span>                                  group_prior_var <span class="op">=</span> <span class="va">group_prior_var</span>,</span>
<span>                                  min_nonSNP_PIP <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>                                  ncore <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span><span class="va">screened_region_data</span> <span class="op">&lt;-</span> <span class="va">screen_res</span><span class="op">$</span><span class="va">screened_region_data</span></span>
<span><span class="va">screen_summary</span> <span class="op">&lt;-</span> <span class="va">screen_res</span><span class="op">$</span><span class="va">screen_summary</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="expanding-selected-regions-with-all-snps">Expanding selected regions with all SNPs<a class="anchor" aria-label="anchor" href="#expanding-selected-regions-with-all-snps"></a>
</h4>
<p>After screening regions, we expand the selected regions with all SNPs for final fine-mapping. (This is not needed when <code>thin = 1</code>.)</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">screened_region_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/expand_region_data.html">expand_region_data</a></span><span class="op">(</span><span class="va">screened_region_data</span>,</span>
<span>                                           <span class="va">snp_map</span>,</span>
<span>                                           <span class="va">z_snp</span>,</span>
<span>                                           maxSNP <span class="op">=</span> <span class="fl">20000</span>,</span>
<span>                                           ncore <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span></span>
<span><span class="va">screen_res</span><span class="op">$</span><span class="va">screened_region_data</span> <span class="op">&lt;-</span> <span class="va">screened_region_data</span></span></code></pre></div>
<p>If the number of SNPs in a region is more than <code>maxSNP</code>, it will choose the top <code>maxSNP</code> SNPs with the highest Z-scores.</p>
</div>
</div>
<div class="section level3">
<h3 id="fine-mapping-regions">Fine-mapping regions<a class="anchor" aria-label="anchor" href="#fine-mapping-regions"></a>
</h3>
<div class="section level4">
<h4 id="fine-mapping-regions-with-ld">Fine-mapping regions with LD<a class="anchor" aria-label="anchor" href="#fine-mapping-regions-with-ld"></a>
</h4>
<p>We now perform the fine-mapping step for each of the selected regions from screening with the estimated parameters.</p>
<p>The <code><a href="../reference/finemap_regions.html">finemap_regions()</a></code> function performs fine-mapping for the regions in the <code>screened_region_data</code>.</p>
<p>It first computes correlation matrices among all variables included in fine-mapping (SNPs, and molecular traits), then runs fine-mapping with estimated parameters (<code>group_prior</code> and <code>group_prior_var</code>) and estimated number of causal signals (<code>screened_region_L</code>), and returns a data frame with fine-mapping results for the regions.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/finemap_regions.html">finemap_regions</a></span><span class="op">(</span><span class="va">screened_region_data</span>,</span>
<span>                       LD_map <span class="op">=</span> <span class="va">LD_map</span>,</span>
<span>                       weights <span class="op">=</span> <span class="va">weights</span>,</span>
<span>                       group_prior <span class="op">=</span> <span class="va">group_prior</span>,</span>
<span>                       group_prior_var <span class="op">=</span> <span class="va">group_prior_var</span>,</span>
<span>                       L <span class="op">=</span> <span class="va">screened_region_L</span>,</span>
<span>                       min_abs_corr <span class="op">=</span> <span class="fl">0.1</span>, </span>
<span>                       save_cor <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                       cor_dir <span class="op">=</span> <span class="st">"./cor_matrix"</span>,</span>
<span>                       ncore <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">finemap_res</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">finemap_res</span></span>
<span><span class="va">susie_alpha_res</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">susie_alpha_res</span></span></code></pre></div>
<p>cTWAS will automatically check <code>cor_dir</code>. If precomputed correlation matrices are available in <code>cor_dir</code>, cTWAS will simply load and reuse those. Otherwise, it will compute the correlation matrices and save to the <code>cor_dir</code> directory if <code>save_cor = TRUE</code>. You can set <code>force_compute_cor = TRUE</code> so that it always computes the correlation matrices. The correlation matrices are large datasets, so they are not saved by default.</p>
<p><em>Note</em>: when screening regions and fine-mapping with LD, we need larger memory to load LD matrices and compute correlation matrices. So we recommend increasing memory or reducing the number of <code>ncore</code> for these steps.</p>
<p>It is possible to run fine-mapping using uniform prior, treating all variants and molecular traits equally. To do this, we set <code>group_prior = NULL</code> (uniform prior inclusion probabilities) and <code>group_prior_var = NULL</code> (prior variance = 50 as the default in <code>susie_rss</code>).</p>
</div>
<div class="section level4">
<h4 id="fine-mapping-regions-without-ld">Fine-mapping regions without LD<a class="anchor" aria-label="anchor" href="#fine-mapping-regions-without-ld"></a>
</h4>
<p><em>Note</em>: we could use the <code><a href="../reference/finemap_regions_noLD.html">finemap_regions_noLD()</a></code> function to run fine-mapping without LD.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/finemap_regions_noLD.html">finemap_regions_noLD</a></span><span class="op">(</span><span class="va">screened_region_data</span>,</span>
<span>                            group_prior <span class="op">=</span> <span class="va">group_prior</span>,</span>
<span>                            group_prior_var <span class="op">=</span> <span class="va">group_prior_var</span>,</span>
<span>                            ncore <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span><span class="va">finemap_res</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">finemap_res</span></span>
<span><span class="va">susie_alpha_res</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">susie_alpha_res</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="fine-mapping-a-single-region">Fine-mapping a single region<a class="anchor" aria-label="anchor" href="#fine-mapping-a-single-region"></a>
</h3>
<p>We could also run fine-mapping for a single region (or several regions of interest) with precomputed parameters. This is particularly useful to perform a deep analysis on molecular traits for regions of interest.</p>
<p>Here we show an example for fine-mapping a single region “16_71020125_72901251”.</p>
<p>We first select the data for the region of interest from <code>screened_region_data</code>. We also need the number of causal signals (<code>L</code>) for this region. These are obtained from the output of the earlier <code><a href="../reference/screen_regions.html">screen_regions()</a></code> function.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">region_id</span> <span class="op">&lt;-</span> <span class="st">"16_71020125_72901251"</span></span>
<span><span class="va">selected_region_data</span> <span class="op">&lt;-</span> <span class="va">screened_region_data</span><span class="op">[</span><span class="va">region_id</span><span class="op">]</span></span>
<span><span class="va">selected_region_L</span> <span class="op">&lt;-</span> <span class="va">screened_region_L</span><span class="op">[</span><span class="va">region_id</span><span class="op">]</span></span></code></pre></div>
<p>We could then perform fine-mapping for this region of interest:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/finemap_regions.html">finemap_regions</a></span><span class="op">(</span><span class="va">selected_region_data</span>,</span>
<span>                       LD_map <span class="op">=</span> <span class="va">LD_map</span>,</span>
<span>                       weights <span class="op">=</span> <span class="va">weights</span>,</span>
<span>                       group_prior <span class="op">=</span> <span class="va">group_prior</span>,</span>
<span>                       group_prior_var <span class="op">=</span> <span class="va">group_prior_var</span>,</span>
<span>                       L <span class="op">=</span> <span class="va">selected_region_L</span>,</span>
<span>                       save_cor <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                       cor_dir <span class="op">=</span> <span class="st">"./cor_matrix"</span><span class="op">)</span></span>
<span><span class="va">finemap_res</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">finemap_res</span></span>
<span><span class="va">susie_alpha_res</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">susie_alpha_res</span></span></code></pre></div>
<p>We could also perform fine-mapping without LD:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/finemap_regions_noLD.html">finemap_regions_noLD</a></span><span class="op">(</span><span class="va">selected_region_data</span>,</span>
<span>                            group_prior <span class="op">=</span> <span class="va">group_prior</span>,</span>
<span>                            group_prior_var <span class="op">=</span> <span class="va">group_prior_var</span><span class="op">)</span></span>
<span><span class="va">finemap_res</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">finemap_res</span></span>
<span><span class="va">susie_alpha_res</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">susie_alpha_res</span></span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Siming Zhao, Wesley Crouse, Sheng Qian, Kaixuan Luo, Matthew Stephens, Xin He.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
