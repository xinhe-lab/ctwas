<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Preparing cTWAS input data • ctwas</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Preparing cTWAS input data">
<meta property="og:description" content="ctwas">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ctwas</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.5.18</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Tutorial
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/minimal_tutorial.html">A minimal tutorial of running cTWAS without LD</a>
    </li>
    <li>
      <a href="../articles/preparing_input_data.html">Preparing cTWAS input data</a>
    </li>
    <li>
      <a href="../articles/running_ctwas_analysis.html">Running cTWAS analysis</a>
    </li>
    <li>
      <a href="../articles/summarizing_results.html">Summarizing and visualizing cTWAS results</a>
    </li>
    <li>
      <a href="../articles/sample_report.html">Sample report of cTWAS results</a>
    </li>
    <li>
      <a href="../articles/postprocessing.html">Post-processing cTWAS results</a>
    </li>
    <li>
      <a href="../articles/utility_functions.html">cTWAS utility functions</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/FAQ.html">FAQ</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/software_updates.html">Software updates</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/xinhe-lab/ctwas/tree/multigroup" class="external-link">Source</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="preparing_input_data_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Preparing cTWAS input data</h1>
                        <h4 data-toc-skip class="author">Kaixuan Luo, Sheng Qian</h4>
            
            <h4 data-toc-skip class="date">2025-05-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/xinhe-lab/ctwas/blob/multigroup/vignettes/preparing_input_data.Rmd" class="external-link"><code>vignettes/preparing_input_data.Rmd</code></a></small>
      <div class="hidden name"><code>preparing_input_data.Rmd</code></div>

    </div>

    
    
<p>This tutorial shows how to prepare for the input data for running cTWAS with summary statistics.</p>
<p>Load the packages</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/xinhe-lab/ctwas/" class="external-link">ctwas</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span></code></pre></div>
<p>We use <code>VariantAnnotation</code> and <code>gwasvcf</code> packages to read the VCF files, so please install those packages before running this tutorial.</p>
<p>The inputs include GWAS summary statistics, prediction models (referred to as “weights” in the documents), and LD reference. Additionally, cTWAS partitions the genome into disjoint regions, assuming no LD across regions. So a user also needs to provide the definition of these regions.</p>
<p>Note: In most sections of this tutorial, we assume we run full cTWAS using the LD reference. To run cTWAS without LD, see the <a href="https://xinhe-lab.github.io/multigroup_ctwas/articles/minimal_tutorial.html" class="external-link">“minimal tutorial of running cTWAS without LD”</a>.</p>
<p>In the tutorial, we use sample data provided in the package.</p>
<div class="section level2">
<h2 id="gwas-z-scores">GWAS Z-scores<a class="anchor" aria-label="anchor" href="#gwas-z-scores"></a>
</h2>
<p>We will use summary statistics from a GWAS of LDL cholesterol in the UK Biobank.</p>
<p>We can download the VCF from the IEU Open GWAS Project.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">wget</span> https://gwas.mrcieu.ac.uk/files/ukb-d-30780_irnt/ukb-d-30780_irnt.vcf.gz</span></code></pre></div>
<p>We use <code>VariantAnnotation</code> and <code>gwasvcf</code> packages to read the VCF files.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gwas</span> <span class="op">&lt;-</span> <span class="fu">VariantAnnotation</span><span class="fu">::</span><span class="fu">readVcf</span><span class="op">(</span><span class="st">"ukb-d-30780_irnt.vcf.gz"</span><span class="op">)</span></span>
<span><span class="va">gwas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu">gwasvcf</span><span class="fu">::</span><span class="fu">vcf_to_tibble</span><span class="op">(</span><span class="va">gwas</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>cTWAS needs a data frame <code>z_snp</code> as input, with columns “id”, “A1”, “A2”, “z”. Each row has data of a variant. cTWAS uses rsIDs as variant IDs (<code>id</code>) by default, for those variants without rsIDs, the variant IDs in our reference data are in the UK Biobank format (“chr:pos_ref_alt”). The naming of variant IDs should be consistent between GWAS summary statistics, LD reference and prediction models. See the section “Data harmonization” below on how to convert the formats of variant IDs. <code>A1</code> is the alternate allele, and <code>A2</code> is the reference allele. <code>z</code> is the Z-scores of variants in GWAS. In the GWAS summary statistics VCF file we downloaded here, Z-scores are not available, so we need to compute them from the effect sizes and standard errors.</p>
<p>In the tutorial below, we use sample data from chr16. We use the function <code><a href="../reference/read_gwas.html">read_gwas()</a></code> to read GWAS summary statistics, and compute Z-scores.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gwas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/sample_data"</span>, <span class="st">"LDL_example.gwas.sumstats.RDS"</span>, package <span class="op">=</span> <span class="st">"ctwas"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">gwas</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   seqnames start   end width strand paramRangeID REF ALT QUAL FILTER         ES</span></span>
<span><span class="co">## 1       16 60455 60455     1      *         &lt;NA&gt;   G   C   NA   PASS -0.0190880</span></span>
<span><span class="co">## 2       16 81639 81639     1      *         &lt;NA&gt;   C   A   NA   PASS  0.0047246</span></span>
<span><span class="co">## 3       16 83520 83520     1      *         &lt;NA&gt;   T   C   NA   PASS  0.0062589</span></span>
<span><span class="co">## 4       16 83626 83626     1      *         &lt;NA&gt;   G   A   NA   PASS  0.0064091</span></span>
<span><span class="co">## 5       16 83629 83629     1      *         &lt;NA&gt;   C   A   NA   PASS  0.0067336</span></span>
<span><span class="co">## 6       16 83802 83802     1      *         &lt;NA&gt;   G   A   NA   PASS  0.0050033</span></span>
<span><span class="co">##          SE       LP        AF     SS EZ SI NC          ID               id</span></span>
<span><span class="co">## 1 0.0185710 0.517084 0.0043405 343621 NA NA NA rs191816316 ukb-d-30780_irnt</span></span>
<span><span class="co">## 2 0.0032757 0.826202 0.8237500 343621 NA NA NA   rs2858946 ukb-d-30780_irnt</span></span>
<span><span class="co">## 3 0.0034617 1.151200 0.1440100 343621 NA NA NA rs186272033 ukb-d-30780_irnt</span></span>
<span><span class="co">## 4 0.0030961 1.415140 0.1962900 343621 NA NA NA  rs28678857 ukb-d-30780_irnt</span></span>
<span><span class="co">## 5 0.0029186 1.676810 0.2137200 343621 NA NA NA   rs2562130 ukb-d-30780_irnt</span></span>
<span><span class="co">## 6 0.0047199 0.538907 0.0680050 343621 NA NA NA  rs28436661 ukb-d-30780_irnt</span></span>
<span><span class="co">##          rsid</span></span>
<span><span class="co">## 1 rs191816316</span></span>
<span><span class="co">## 2   rs2858946</span></span>
<span><span class="co">## 3 rs186272033</span></span>
<span><span class="co">## 4  rs28678857</span></span>
<span><span class="co">## 5   rs2562130</span></span>
<span><span class="co">## 6  rs28436661</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">z_snp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_gwas.html">read_gwas</a></span><span class="op">(</span><span class="va">gwas</span>, id <span class="op">=</span> <span class="st">'rsid'</span>, A1 <span class="op">=</span> <span class="st">'ALT'</span>, A2 <span class="op">=</span> <span class="st">'REF'</span>, beta <span class="op">=</span> <span class="st">'ES'</span>, se <span class="op">=</span> <span class="st">'SE'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">z_snp</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            id A1 A2         z</span></span>
<span><span class="co">## 1 rs191816316  C  G -1.027839</span></span>
<span><span class="co">## 2   rs2858946  A  C  1.442318</span></span>
<span><span class="co">## 3 rs186272033  C  T  1.808042</span></span>
<span><span class="co">## 4  rs28678857  A  G  2.070056</span></span>
<span><span class="co">## 5   rs2562130  A  C  2.307134</span></span>
<span><span class="co">## 6  rs28436661  A  G  1.060044</span></span></code></pre>
<p>We also collect the sample size, which will be used later.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gwas_n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">gwas</span><span class="op">$</span><span class="va">SS</span><span class="op">)</span>,decreasing<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"gwas_n ="</span>, <span class="va">gwas_n</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## gwas_n = 343621</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="prediction-models">Prediction models<a class="anchor" aria-label="anchor" href="#prediction-models"></a>
</h2>
<p>Prediction models can be specified in either PredictDB or FUSION format. PredictDB is the recommended format, as it has information about correlations among variants included in a model, and also has extra information about the genes/molecular traits in the model. In this user guide, we focus on the PredictDB format. Please check <a href="http://predictdb.org/" class="external-link">PredictDB</a> for the format of PredictDB weights. Please save both the prediction models (.db) and the covariances between variants in the prediction models (.txt.gz) in the same directory. The covariances can optionally be used for computing LD. For <a href="http://gusevlab.org/projects/fusion/#compute-your-own-predictive-models" class="external-link">FUSION format</a>, please see section “FUSION weights” in the tutorial <a href="https://xinhe-lab.github.io/multigroup_ctwas/articles/utility_functions.html" class="external-link">“Utility functions”</a> for details. We also note that it is possible to run cTWAS with only a list of QTLs, which is often the case in practice. See the section “Creating prediction models from QTL lists” in the tutorial <a href="https://xinhe-lab.github.io/multigroup_ctwas/articles/utility_functions.html" class="external-link">“Utility functions”</a> for details.</p>
<p>In terms of the choice of prediction models, cTWAS performs best when prediction models are sparse, i.e. they have relatively few variants per molecular trait. Dense weights may lead to a “cross-region” problem. Basically, if the variants in the prediction model of a molecular trait span two regions, it would be unclear to cTWAS what region the molecular trait should be assigned to. The problem becomes worse with dense weights. If this happens, cTWAS will attempt to assign the molecular trait to one of the two regions that contain most of the weights. Nevertheless, there will be a risk of cross-region LD which can lead to problems. Given this consideration, we recommend choosing sparse prediction models such as Lasso. If using dense prediction models, we recommend removing variants with weights below a threshold from the prediction models.</p>
<p>Note: we implemented an option to address the “cross-region” problem. It performs “region merging” as a post-processing step. If any molecular trait has variants in the weights that span two regions, those regions will be merged, and cTWAS will rerun the analysis using the merged regions. See the tutorial <a href="https://xinhe-lab.github.io/multigroup_ctwas/articles/postprocessing.html" class="external-link">“Post-processing cTWAS results”</a>] for details.</p>
<p>In this example, we will use liver and subcutaneous adipose gene expression models trained on GTEx v8 in the PredictDB format. The weight files have been included in the R package. To specify weights in PredictDB format, provide the path to the <code>.db</code> file when running cTWAS.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weight_liver_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/sample_data"</span>, </span>
<span><span class="st">"expression_Liver.db"</span>, package <span class="op">=</span> <span class="st">"ctwas"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">weight_adipose_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/sample_data"</span>, <span class="st">"expression_Adipose_Subcutaneous.db"</span>, package <span class="op">=</span> <span class="st">"ctwas"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="reference-data">Reference data<a class="anchor" aria-label="anchor" href="#reference-data"></a>
</h2>
<p>The reference data include definitions of genomic regions, and the LD reference. Note that the choice of LD reference population is important for fine-mapping. Best practice for fine-mapping is to use an in-sample LD reference (LD computed using the subjects in the GWAS sample). If this is not available, the LD reference should be as representative of the population in the GWAS sample as possible.</p>
<p>It is critical that the genome build of the LD reference matches the genome build used to train the prediction models, so that variants without rsIDs will not be filtered out due to inconsistent variant IDs.</p>
<p>We can use the function <code><a href="../reference/get_predictdb_genome_build.html">get_predictdb_genome_build()</a></code> to read the genome build of PredictDB weight file:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weight_liver_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/sample_data"</span>, </span>
<span><span class="st">"expression_Liver.db"</span>, package <span class="op">=</span> <span class="st">"ctwas"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/get_predictdb_genome_build.html">get_predictdb_genome_build</a></span><span class="op">(</span><span class="va">weight_liver_file</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "b38"</span></span></code></pre>
<p>The variant positions of the GWAS summary statistics do not matter because cTWAS use variant positions from the LD reference.</p>
<div class="section level3">
<h3 id="defining-regions">Defining regions<a class="anchor" aria-label="anchor" href="#defining-regions"></a>
</h3>
<p>cTWAS assumes that the genome is partitioned into approximately independent LD regions.</p>
<p>We included in the package predefined regions based on European (EUR), Asian (ASN), or African (AFR) populations, using either genome build b38 or b37. These regions were previously generated using <a href="https://doi.org/10.1093/bioinformatics/btv546" class="external-link">LDetect</a>.</p>
<p>Here we use the b38 European LDetect blocks, which is again included in the R package.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">region_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/ldetect"</span>, <span class="st">"EUR.b38.ldetect.regions.RDS"</span>, package <span class="op">=</span> <span class="st">"ctwas"</span><span class="op">)</span></span>
<span><span class="va">region_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">region_file</span><span class="op">)</span></span>
<span><span class="va">region_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">region_info</span>, <span class="va">chrom</span> <span class="op">==</span> <span class="fl">16</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">region_info</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      chrom   start    stop          region_id</span></span>
<span><span class="co">## 1428    16   10054 1157206   16_10054_1157206</span></span>
<span><span class="co">## 1429    16 1157206 2714828 16_1157206_2714828</span></span>
<span><span class="co">## 1430    16 2714828 3951195 16_2714828_3951195</span></span>
<span><span class="co">## 1431    16 3951195 5068344 16_3951195_5068344</span></span>
<span><span class="co">## 1432    16 5068344 5841579 16_5068344_5841579</span></span>
<span><span class="co">## 1433    16 5841579 6843550 16_5841579_6843550</span></span></code></pre>
<p><code>region_info</code> contains the region definitions, and IDs of the regions (by default, we use the convention <chrom_start_stop> for the region IDs).</chrom_start_stop></p>
<p>In this tutorial, we use chr16 as an example, so we specify <code>chrom = 16</code>. In real cTWAS analysis, you should run the entire genome.</p>
</div>
<div class="section level3">
<h3 id="reference-variants-and-ld-matrices">Reference variants and LD matrices<a class="anchor" aria-label="anchor" href="#reference-variants-and-ld-matrices"></a>
</h3>
<p>cTWAS performs its analysis region-by-region. The preferred way to run cTWAS is to provide pre-computed LD matrices for each region. If you run cTWAS without using LD matrices, please jump to the section “Mapping reference SNPs to regions” below.</p>
<p>By default, we need a LD matrix file for each region (preferably in <code>.RDS</code> format) and a variant information table accompanying each LD matrix. The <code>.RDS</code> files store the LD correlation matrix (R) for each region (a <span class="math inline">\(p \times p\)</span> matrix, <span class="math inline">\(p\)</span> is the number of variants in the region). The accompanying <code>.Rvar</code> files include variant information for the region, and the order of its rows should match the order of rows and columns in the <code>.RDS</code> file.</p>
<p>We have precomputed reference LD matrices (<code>.RDS</code> files) and the variant information tables (<code>.Rvar</code> files) accompanying the LD matrices for UK Biobank. LD matrices were computed on 10% of the UK Biobank independent, White British samples for variants with MAF &gt; 1%.</p>
<p>The complete LD matrices of European individuals from UK Biobank can be downloaded <a href="https://uchicago.box.com/s/jqocacd2fulskmhoqnasrknbt59x3xkn" class="external-link">here</a>. On the University of Chicago RCC cluster, the b38 reference is available at <code>/project2/mstephens/wcrouse/UKB_LDR_0.1/</code> and the b37 reference is available at <code>/project2/mstephens/wcrouse/UKB_LDR_0.1_b37/</code>.</p>
<p>The columns of the <code>.Rvar</code> file include information on chromosome, variant name, position in base pairs, and the alternative and reference alleles. The “variance” column is the variance of each variant prior to standardization; this is required for PredictDB weights but not FUSION weights. We’ve also included information on allele frequency (for the alternative alleles) in the variant info, but this is optional and not used in the program.</p>
<p>Each variant should be uniquely assigned to a region, and the regions should be left closed and right open, i.e. [start, stop). The positions of the LD matrices must match exactly the positions specified by the region file. Do not include multiallelic variants in the LD reference.</p>
</div>
<div class="section level3">
<h3 id="mapping-reference-snps-and-ld-matrices-to-regions">Mapping reference SNPs and LD matrices to regions<a class="anchor" aria-label="anchor" href="#mapping-reference-snps-and-ld-matrices-to-regions"></a>
</h3>
<p>We will need to link the reference SNP and LD files to the regions. To do this, we add two additional columns “LD_file” and “SNP_file” to <code>region_info</code>: “LD_file” stores the filenames to the precomputed LD (R) matrices (<code>.RDS</code> files in our precomputed reference LD files), “SNP_file” stores the filenames of corresponding variant information (<code>.Rvar</code> files). The result is stored in a data frame <code>region_metatable</code>.</p>
<p>The following paths and filenames were from the University of Chicago RCC cluster, please replace them with your own paths.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">LD_dir</span> <span class="op">&lt;-</span> <span class="st">"/project2/mstephens/wcrouse/UKB_LDR_0.1"</span></span>
<span><span class="va">genome_version</span> <span class="op">&lt;-</span> <span class="st">"b38"</span></span>
<span></span>
<span><span class="va">LD_filestem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"ukb_%s_0.1_chr%s.R_snp.%s_%s"</span>, <span class="va">genome_version</span>, <span class="va">region_info</span><span class="op">$</span><span class="va">chrom</span>, <span class="va">region_info</span><span class="op">$</span><span class="va">start</span>, <span class="va">region_info</span><span class="op">$</span><span class="va">stop</span><span class="op">)</span></span>
<span></span>
<span><span class="va">region_metatable</span> <span class="op">&lt;-</span> <span class="va">region_info</span></span>
<span><span class="va">region_metatable</span><span class="op">$</span><span class="va">LD_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">LD_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">LD_filestem</span>, <span class="st">".RDS"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">region_metatable</span><span class="op">$</span><span class="va">SNP_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">LD_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">LD_filestem</span>, <span class="st">".Rvar"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="../reference/create_snp_LD_map.html">create_snp_LD_map()</a></code> function takes <code>region_metatable</code> as input, extracts the region definitions, ensures that it matches the format required by cTWAS (e.g. adding “region_id” column if not available), and returns updated <code>region_info</code>. It reads the variant information from the regions, and returns the result as <code>snp_map</code>. <code>snp_map</code> will be used when we need reference SNP information. The function also checks the “LD_file” and “SNP_file” columns of <code>region_metatable</code> to make sure the files are available. It then returns <code>LD_map</code>, a data frame with the “region_id”, “LD_file” and “SNP_file” columns of <code>region_metatable</code>. <code>LD_map</code> will be used when we need LD matrices, e.g. when computing correlations for fine-mapping.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_snp_LD_map.html">create_snp_LD_map</a></span><span class="op">(</span><span class="va">region_metatable</span><span class="op">)</span></span>
<span><span class="va">region_info</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">region_info</span></span>
<span><span class="va">snp_map</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">snp_map</span></span>
<span><span class="va">LD_map</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">LD_map</span></span></code></pre></div>
<p>The <code>snp_map</code> and “SNP_file” column of <code>LD_map</code> both contain reference SNP information, which may seem redundant. The reason is that when computing correlations for a region, the LD matrix is often very large, and the <code>snp_map</code> object is quite large too. Loading the LD matrix and the corresponding SNP information from the <code>LD_file</code> and <code>SNP_file</code> in <code>LD_map</code> has much less burden on memory.</p>
</div>
<div class="section level3">
<h3 id="mapping-reference-snps-to-regions-without-ld">Mapping reference SNPs to regions (without LD)<a class="anchor" aria-label="anchor" href="#mapping-reference-snps-to-regions-without-ld"></a>
</h3>
<p>When preparing data without LD, we need <code>region_info</code> (region definitions, no need to provide “LD_file” and “SNP_file” columns) and <code>ref_snp_info</code>, a data frame containing information of all variants from the reference.</p>
<p>We have the reference variant information from UK Biobank European population available <a href="https://uchicago.box.com/s/w3j3w49a5y5p1rhlti95u324g8ro6kkn" class="external-link">here</a>.</p>
<p>On the University of Chicago RCC cluster, the reference variant information is available at <code>/project2/xinhe/shared_data/cTWAS/ref_snp_info/</code>.</p>
<p>We then use the <code><a href="../reference/create_snp_map.html">create_snp_map()</a></code> function to preprocess region definitions, and map variants from the LD reference to regions, which returns processed <code>region_info</code> and <code>snp_map</code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ref_snp_info_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/sample_data"</span>, <span class="st">"ukb_b38_0.1_chr16_var_info.Rvar.gz"</span>, package <span class="op">=</span> <span class="st">"ctwas"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ref_snp_info</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span><span class="va">ref_snp_info_file</span>, sep <span class="op">=</span> <span class="st">"\t"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">ref_snp_info</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"data.frame"</span></span>
<span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_snp_map.html">create_snp_map</a></span><span class="op">(</span><span class="va">region_info</span>, <span class="va">ref_snp_info</span><span class="op">)</span></span>
<span><span class="va">region_info</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">region_info</span></span>
<span><span class="va">snp_map</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">snp_map</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="data-harmonization">Data harmonization<a class="anchor" aria-label="anchor" href="#data-harmonization"></a>
</h2>
<p>There are a few potential problems when preparing the input data. First, the variants in the three sets of input data, GWAS summary statistics, weights, and the reference data, may not match. Only variants in all three input data will be used in cTWAS. The <code><a href="../reference/preprocess_weights.html">preprocess_weights()</a></code> function described below will automatically select variants in all three input data. So it is important to maximize the overlap of the variants in the three sets. This can be done for example, by imputing GWAS summary statistics of the variants missing in GWAS but in the LD reference. Another useful pre-processing step is to perform minor allele frequency (MAF) filtering on the GWAS data so that only those with MAF above a certain cutoff would be used in the analysis, ideally the same cutoff used in the references. Additionally, when building the prediction models of gene expression, it is better to impute the genotype data using the LD reference, if possible. All these steps should be done before running cTWAS.</p>
<p>The second potential problem is that the effect alleles in the prediction model, GWAS and LD reference may not agree with each other, thus we need to “harmonize” the data to ensure that the effect alleles match in all three data sources.</p>
<p>Another potential problem is the LD of the GWAS data (in-sample LD) do not match the reference LD. This can lead to problems in fine-mapping. Diagnostic tools including <a href="https://stephenslab.github.io/susieR/articles/susierss_diagnostic.html" class="external-link">SuSiE-RSS</a>, and <a href="https://github.com/Yves-CHEN/DENTIST/" class="external-link">DENTIST</a>, have been developed to check possible LD mismatch. We have provided such analysis in cTWAS. However, it is time consuming to run the LD mismatch diagnosis for all the regions across the genome, so we will perform the diagnosis and adjustment only for selected regions with high PIP signals in the post-processing step. Please see the tutorial <a href="https://xinhe-lab.github.io/multigroup_ctwas/articles/postprocessing.html" class="external-link">“Post-processing cTWAS results”</a> for details.</p>
<p>Below we describe several functions to harmonize the input datasets.</p>
<div class="section level3">
<h3 id="harmonizing-gwas-z-scores-and-the-reference-data">Harmonizing GWAS z-scores and the reference data<a class="anchor" aria-label="anchor" href="#harmonizing-gwas-z-scores-and-the-reference-data"></a>
</h3>
<p>The <code><a href="../reference/preprocess_z_snp.html">preprocess_z_snp()</a></code> function harmonizes GWAS z-scores and the reference data based on the included allele information.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">z_snp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/preprocess_z_snp.html">preprocess_z_snp</a></span><span class="op">(</span><span class="va">z_snp</span>, <span class="va">snp_map</span>, </span>
<span>                          drop_multiallelic <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                          drop_strand_ambig <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                          varID_converter_fun <span class="op">=</span> <span class="va">convert_to_ukb_varIDs</span><span class="op">)</span></span></code></pre></div>
<p>It will filter out variants not included in the reference data. It will also drop multiallelic variants and strand ambiguous variants, by default. You can change these by setting the options <code>drop_multiallelic</code> and <code>drop_strand_ambig</code>.</p>
<p>The naming of variant IDs should be consistent between GWAS, LD reference and weights. We use a converter function <code><a href="../reference/convert_to_ukb_varIDs.html">convert_to_ukb_varIDs()</a></code> that converts variant IDs in GWAS from the Open GWAS format (“chr_pos_ref_alt”) to our reference format from UK Biobank (“chr:pos_ref_alt”). To convert the formats for other variant ID formats, you can pass your own converter function to the <code>varID_converter_fun</code> argument.</p>
</div>
<div class="section level3">
<h3 id="harmonizing-prediction-models-and-the-reference-data">Harmonizing prediction models and the reference data<a class="anchor" aria-label="anchor" href="#harmonizing-prediction-models-and-the-reference-data"></a>
</h3>
<p>We use the <code>preprocess_weight()</code> function to harmonize the PredictDB/FUSION prediction models and LD reference.</p>
<p>In this version of cTWAS, we allow the joint analysis of multiple groups of molecular traits. This could be: eQTL of multiple tissues; or eQTLs, splicing QTLs and other types of QTLs in a single tissue. In a more complex setting, multiple types of QTL data from multiple tissues/cell types. Each group is defined by its “type” (kind of molecular traits), and “context” (tissue, cell type, condition, etc.). So, we specify the <code>type</code> and <code>context</code> arguments for each weight file as the example below. We also assign a <code>weight_name</code> to represent each weight file. By default, <code>weight_name</code> is set to <context_type>.</context_type></p>
<p>We get a list of processed weights for each weight file, and then we simply concatenate them to get a list of all processed weights from different types or contexts.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weights_liver</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/preprocess_weights.html">preprocess_weights</a></span><span class="op">(</span><span class="va">weight_liver_file</span>,</span>
<span>                                    <span class="va">region_info</span>,</span>
<span>                                    gwas_snp_ids <span class="op">=</span> <span class="va">z_snp</span><span class="op">$</span><span class="va">id</span>,</span>
<span>                                    snp_map <span class="op">=</span> <span class="va">snp_map</span>,</span>
<span>                                    type <span class="op">=</span> <span class="st">"expression"</span>,</span>
<span>                                    context <span class="op">=</span> <span class="st">"liver"</span>,</span>
<span>                                    weight_name <span class="op">=</span> <span class="st">"liver_expression"</span>,</span>
<span>                                    weight_format <span class="op">=</span> <span class="st">"PredictDB"</span>,</span>
<span>                                    drop_strand_ambig <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                    scale_predictdb_weights <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                    load_predictdb_LD <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                    filter_protein_coding_genes <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                    varID_converter_fun <span class="op">=</span> <span class="va">convert_to_ukb_varIDs</span>,</span>
<span>                                    ncore <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span></span>
<span><span class="va">weights_adipose</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/preprocess_weights.html">preprocess_weights</a></span><span class="op">(</span><span class="va">weight_adipose_file</span>,</span>
<span>                                      <span class="va">region_info</span>,</span>
<span>                                      gwas_snp_ids <span class="op">=</span> <span class="va">z_snp</span><span class="op">$</span><span class="va">id</span>,</span>
<span>                                      snp_map <span class="op">=</span> <span class="va">snp_map</span>,</span>
<span>                                      type <span class="op">=</span> <span class="st">"expression"</span>,</span>
<span>                                      context <span class="op">=</span> <span class="st">"adipose"</span>,</span>
<span>                                      weight_name <span class="op">=</span> <span class="st">"adipose_expression"</span>,</span>
<span>                                      weight_format <span class="op">=</span> <span class="st">"PredictDB"</span>, </span>
<span>                                      drop_strand_ambig <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                      scale_predictdb_weights <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                      load_predictdb_LD <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                      filter_protein_coding_genes <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                      varID_converter_fun <span class="op">=</span> <span class="va">convert_to_ukb_varIDs</span>,</span>
<span>                                      ncore <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span></span>
<span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">weights_liver</span>, <span class="va">weights_adipose</span><span class="op">)</span></span></code></pre></div>
<p>This function returns <code>weights</code>, which contains the effect sizes of the variants in the prediction models, LD of variants in the weights, the first and last QTL positions of molecular traits.</p>
<p>In the function above, we specify the weight format in <code>weight_format</code>. We use PredictDB format by default, and we recommend <a href="https://predictdb.org/post/2021/07/21/gtex-v8-models-on-eqtl-and-sqtl/#mashr-based-models" class="external-link">MASHR-based models</a>. When <code>load_predictdb_LD = TRUE</code> (default option for PredictDB weights), cTWAS will compute LD of variants in weights (<code>R_wgt</code>) using pre-computed covariances between variants in PredictDB weights (<code>.txt.gz</code>). LD in weights will be used when computing gene Z-scores later. When using FUSION weights, or when <code>load_predictdb_LD = FALSE</code>, cTWAS will compute LD for variants in weights using reference LD matrices, thus <code>LD_map</code> will be required.</p>
<p>PredictDB weights assume that variant genotypes are not standardized, but our implementation assumes standardized variant genotypes. Thus, we set <code>scale_predictdb_weights = TRUE</code>, to scale PredictDB weights by the variance before computing Z-scores of molecular traits. If weights are already on the standardized scale (e.g. FUSION weights or PredictDB weights converted from eQTLs), this scaling should be turned off.</p>
<p>We limit variants in weights, reference (<code>snp_map</code>) and GWAS SNPs (<code>z_snp$id</code>). We drop strand ambiguous variants (<code>drop_strand_ambig = TRUE</code>) by default. We could limit weights to protein coding genes (<code>filter_protein_coding_genes = TRUE</code>) based on the <code>gene_type</code> information in the “extra table” of PredictDB weights. We set <code>ncore</code> to parallelize the computation.</p>
<p>Similar to <code><a href="../reference/preprocess_z_snp.html">preprocess_z_snp()</a></code>, we use a converter function <code><a href="../reference/convert_to_ukb_varIDs.html">convert_to_ukb_varIDs()</a></code> that converts variant IDs in weights from the PredictDB format (“chr_pos_ref_alt_build”) to our reference format from UK Biobank (“chr:pos_ref_alt”). To convert the formats for other variant ID formats, you can pass your own converter function to the <code>varID_converter_fun</code> argument.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Siming Zhao, Wesley Crouse, Sheng Qian, Kaixuan Luo, Matthew Stephens, Xin He.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
