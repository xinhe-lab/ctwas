---
title: "Using cTWAS main function"
author: "Kaixuan Luo, Sheng Qian"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using cTWAS main function}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE,
                      fig.width = 6,
                      fig.height = 4,
                      fig.align = "center",
                      fig.cap = "&nbsp;",
                      dpi = 120)
```



## Running cTWAS analysis with the main function

In this tutorial, we will show how to perform cTWAS analysis using the main function. 

We require first running the data preprocessing and harmonization steps before running cTWAS main analysis. 

Please follow the "Preparing cTWAS input data" tutorial to prepare cTWAS input data.

Load the packages
```{r load_package, message=FALSE}
library(ctwas)
```


We use the function `ctwas_sumstats()` to run cTWAS analysis with LD. It takes as input preprocessed GWAS z-scores (`z_snp`), `weights`, `region_info`, `LD_info` and `snp_info`, and will perform the main steps: (i) computing Z-scores of genes; (i) estimating model parameters; (iii) screening regions potentially containing causal genes, and (iv) fine-mapping those regions. 


Let's first load the preprocessed input data:

```{r load_ctwas_res}
z_snp <- readRDS(system.file("extdata/sample_data", "LDL_example.preprocessed.z_snp.RDS", package = "ctwas"))

weights <- readRDS(system.file("extdata/sample_data", "LDL_example.preprocessed.weights.RDS", package = "ctwas"))

region_info <- readRDS(system.file("extdata/sample_data", "LDL_example.region_info.RDS", package = "ctwas"))

snp_info <- readRDS(system.file("extdata/sample_data", "LDL_example.snp_info.RDS", package = "ctwas"))

LD_info <- readRDS(system.file("extdata/sample_data", "LDL_example.LD_info.RDS", package = "ctwas"))
```


Note: please update the paths to LD matrices in `LD_info` to your own paths.

Now, we can run cTWAS using the `ctwas_sumstats()` function: 
```{r ctwas_sumstats, eval=FALSE}
ctwas_res <- ctwas_sumstats(z_snp, weights, region_info, snp_info, LD_info,
                            ncore = 6, 
                            save_cor = TRUE, 
                            cor_dir = "./cor_matrix")
```


Here, we set `ncore = 6` to parallelize computing over regions using 6 cores. We save the correlation matrices in the directory `"./cor_matrix"`, which will be used later for plotting the results. 

Note that if the Z-scores of the genes, `z_gene`, have already been computed when preparing cTWAS input data, we could specify the `z_gene` argument in the function, then it will skip computing z-scores of genes.


## Running cTWAS without LD matrices

It is possible to run the cTWAS analysis without using LD data if one assumes at most one causal signal per LD region. The downside is that cTWAS may miss causal genes in some regions. Nevertheless, this may be a worthy trade-off, especially in the first pass. 

To do this, we use the function `ctwas_sumstats_noLD()` to run cTWAS analysis without LD. 

```{r ctwas_sumstats_noLD, eval=FALSE}
ctwas_res <- ctwas_sumstats_noLD(z_snp, weights, region_info, snp_info,
                                 ncore = 6)
```


